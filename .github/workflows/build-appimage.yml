name: Build PrusaSlicer AppImage

# Triggers:
# - Manual dispatch with optional version tag
# - Scheduled: Every day at 6:00 UTC to check for new releases
# - On push to main (for testing)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'PrusaSlicer version tag (e.g., version_2.9.4). Leave empty for latest.'
        required: false
        default: ''
  schedule:
    - cron: '0 6 * * *'  # Daily at 6:00 UTC
  push:
    branches:
      - main
    paths:
      - '.github/workflows/build-appimage.yml'

permissions:
  contents: write

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  check-release:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      version: ${{ steps.check.outputs.version }}
      tag: ${{ steps.check.outputs.tag }}
    steps:
      - name: Check for new PrusaSlicer release
        id: check
        run: |
          # Get latest PrusaSlicer release
          LATEST=$(curl -s https://api.github.com/repos/prusa3d/PrusaSlicer/releases/latest | jq -r '.tag_name')
          VERSION=$(echo $LATEST | sed 's/version_//')
          
          echo "Latest PrusaSlicer: $VERSION"
          
          # Check if we already have this version
          OUR_LATEST=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r '.tag_name' || echo "none")
          
          echo "Our latest AppImage: $OUR_LATEST"
          
          # Manual trigger with specific tag
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG="${{ github.event.inputs.tag }}"
            VERSION=$(echo $TAG | sed 's/version_//')
            echo "Manual build requested for: $VERSION"
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=$TAG" >> $GITHUB_OUTPUT
          elif [ "$VERSION" != "$OUR_LATEST" ] && [ "$OUR_LATEST" != "none" ]; then
            echo "New version available!"
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=$LATEST" >> $GITHUB_OUTPUT
          elif [ "$OUR_LATEST" == "none" ]; then
            echo "No releases yet, building latest"
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=$LATEST" >> $GITHUB_OUTPUT
          else
            echo "Already up to date"
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  build:
    needs: check-release
    if: needs.check-release.outputs.should_build == 'true'
    runs-on: ubuntu-24.04
    timeout-minutes: 180
    env:
      VERSION: ${{ needs.check-release.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            locales-all git build-essential autoconf cmake \
            libglu1-mesa-dev libgtk-3-dev libdbus-1-dev \
            libwebkit2gtk-4.1-dev desktop-file-utils libegl-mesa0 \
            libnss-mdns libglx-mesa0 libglx0 libxcb-dri2-0 \
            libxcb-dri3-0 libxcb-glx0 libxcb-present0 libxcb-sync1 \
            libxcb-xfixes0 libxshmfence1 libgl1 libdrm2 libgbm1 \
            libvulkan1 xvfb

      - name: Clone PrusaSlicer
        run: |
          git clone --recursive https://github.com/prusa3d/PrusaSlicer.git
          cd PrusaSlicer
          git fetch --tags
          git checkout ${{ needs.check-release.outputs.tag }}
          echo "Building PrusaSlicer $VERSION"

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: prusaslicer-${{ runner.os }}

      - name: Get dependency hash
        id: dephash
        run: |
          cd PrusaSlicer
          echo "hash=$(git rev-parse HEAD:deps)" >> $GITHUB_OUTPUT

      - name: Cache dependencies
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: PrusaSlicer/deps/build/destdir
          key: deps-${{ runner.os }}-${{ steps.dephash.outputs.hash }}

      - name: Cache downloads
        if: steps.cache-deps.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: PrusaSlicer/deps/download
          key: downloads-${{ runner.os }}-${{ github.run_id }}
          restore-keys: downloads-${{ runner.os }}

      - name: Download GMP (workaround)
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          mkdir -p PrusaSlicer/deps/download/GMP
          curl -o PrusaSlicer/deps/download/GMP/gmp-6.2.1.tar.bz2 \
            https://ftp.gnu.org/gnu/gmp/gmp-6.2.1.tar.bz2 || true

      - name: Build dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          export PATH="/usr/lib/ccache:$PATH"
          cd PrusaSlicer/deps
          mkdir -p build && cd build
          cmake .. -DDEP_WX_GTK3=ON -DDEP_DOWNLOAD_DIR=$(pwd)/../download
          make -j $(nproc)

      - name: Build PrusaSlicer
        run: |
          export PATH="/usr/lib/ccache:$PATH"
          mkdir -p PrusaSlicer/build
          cd PrusaSlicer/build
          cmake .. \
            -DSLIC3R_STATIC=1 \
            -DSLIC3R_GTK=3 \
            -DSLIC3R_PCH=OFF \
            -DCMAKE_PREFIX_PATH=$(pwd)/../deps/build/destdir/usr/local \
            -DCMAKE_INSTALL_PREFIX=/usr
          make -j $(nproc)
          sudo make install

      - name: Create AppImage
        run: |
          export ARCH="$(uname -m)"
          export APPIMAGE_EXTRACT_AND_RUN=1
          
          APPIMAGETOOL="https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-$ARCH.AppImage"
          LIB4BN="https://raw.githubusercontent.com/VHSgunzo/sharun/refs/tags/v0.4.4/lib4bin"
          
          # Prepare AppDir
          mkdir -p AppDir/shared/lib AppDir/usr/share/applications AppDir/etc
          cd AppDir
          
          cp -r /usr/resources ./usr/
          cp /usr/resources/applications/PrusaSlicer.desktop ./usr/share/applications/
          cp /usr/resources/applications/PrusaSlicer.desktop ./
          cp /usr/resources/icons/PrusaSlicer.png ./
          
          ln -s ./usr/share ./share
          ln -s ./usr/resources ./resources
          
          # Bundle libraries
          wget "$LIB4BN" -O ./lib4bin && chmod +x ./lib4bin
          xvfb-run -a -- ./lib4bin -p -v -e -s -k \
            /usr/bin/prusa-slicer \
            /usr/bin/OCCTWrapper.so \
            /usr/lib/"$ARCH"-linux-gnu/libwebkit2gtk* \
            /usr/lib/"$ARCH"-linux-gnu/gdk-pixbuf-*/*/*/* \
            /usr/lib/"$ARCH"-linux-gnu/gio/modules/* \
            /usr/lib/"$ARCH"-linux-gnu/*libnss*.so* \
            /usr/lib/"$ARCH"-linux-gnu/libGL* \
            /usr/lib/"$ARCH"-linux-gnu/libvulkan* \
            /usr/lib/"$ARCH"-linux-gnu/dri/*
          rm -f ./lib4bin
          
          ln -s ../lib/bin/OCCTWrapper.so ./bin/OCCTWrapper.so
          
          # Locale fixes
          cp -r /usr/lib/locale ./lib/
          sed -i -e 's|/usr/lib/locale|././/lib/locale|g' ./bin/prusa-slicer
          cp -r /usr/share/locale ./share/
          sed -i -e 's|/usr/share/locale|././/share/locale|g' ./shared/lib/libc.so.6
          sed -i -e 's|/usr/lib/locale|././/lib/locale|g' ./shared/lib/libc.so.6
          
          # Environment
          echo 'SHARUN_WORKING_DIR=${SHARUN_DIR}
          GSETTINGS_BACKEND=memory
          unset LD_LIBRARY_PATH
          unset LD_PRELOAD' > ./.env
          
          ln ./sharun ./AppRun
          ./sharun -g
          
          cd ..
          
          # Build AppImage
          wget -q "$APPIMAGETOOL" -O ./appimagetool && chmod +x ./appimagetool
          ./appimagetool \
            --comp zstd \
            --mksquashfs-opt -Xcompression-level --mksquashfs-opt 22 \
            -n AppDir "PrusaSlicer-${VERSION}-${ARCH}.AppImage"

      - name: Upload AppImage as artifact
        uses: actions/upload-artifact@v4
        with:
          name: PrusaSlicer-AppImage
          path: "*.AppImage"

      - name: Create GitHub Release
        run: |
          ARCH="$(uname -m)"
          gh release delete "$VERSION" -y || true
          gh release create "$VERSION" \
            --title "PrusaSlicer $VERSION" \
            --notes "Automatically built AppImage for PrusaSlicer $VERSION

          Built from: https://github.com/prusa3d/PrusaSlicer/releases/tag/${{ needs.check-release.outputs.tag }}
          
          ## Installation
          \`\`\`bash
          chmod +x PrusaSlicer-${VERSION}-${ARCH}.AppImage
          ./PrusaSlicer-${VERSION}-${ARCH}.AppImage
          \`\`\`" \
            PrusaSlicer-${VERSION}-${ARCH}.AppImage

  update-docker:
    needs: [check-release, build]
    if: needs.check-release.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Docker build
        run: |
          echo "AppImage ${{ needs.check-release.outputs.version }} built successfully"
          echo "Docker image will be rebuilt on next scheduled run or manual trigger"
